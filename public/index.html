<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Genesys PKCE Call Button</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            padding: 40px;
        }

        #callBtn {
            background: #d40000;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 18px 26px;
            font-size: 18px;
            cursor: pointer;
        }

        #callBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            margin-right: 8px;
        }

        #status {
            margin-top: 18px;
            white-space: pre-wrap;
        }

        #top {
            margin-bottom: 18px;
        }
    </style>
</head>

<body>
    <div id="top">
        <button class="btn" id="loginBtn">Login with Genesys Cloud (PKCE)</button>
        <button class="btn" id="meBtn">Who am I?</button>
    </div>

    <button id="callBtn">SOS</button>
    <div id="status"></div>

    <script>
        const loginBtn = document.getElementById("loginBtn");
        const meBtn = document.getElementById("meBtn");
        const callBtn = document.getElementById("callBtn");
        const status = document.getElementById("status");

        let accessToken = null;

        function setStatus(msg) { status.textContent = msg; }

        function loadTokenFromStorage() {
            try {
                const raw = window.localStorage.getItem("gcAccessToken");
                if (!raw) return;
                const obj = JSON.parse(raw);
                accessToken = obj.access_token || null;
                if (accessToken) setStatus("Token loaded from storage.");
            } catch (e) {
                // ignore
            }
        }

        async function callApi(url, opts = {}) {
            if (!opts.headers) opts.headers = {};
            if (accessToken) opts.headers["Authorization"] = "Bearer " + accessToken;

            const resp = await fetch(url, opts);
            const text = await resp.text();
            let data;
            try { data = JSON.parse(text); } catch { data = { rawText: text }; }
            return { resp, data };
        }

        loginBtn.addEventListener("click", () => {
            // full redirect inside iframe
            window.location.href = "/auth/start";
        });

        meBtn.addEventListener("click", async () => {
            const { resp, data } = await callApi("/api/me");
            setStatus(`HTTP ${resp.status}\n` + JSON.stringify(data, null, 2));
        });

        callBtn.addEventListener("click", async () => {
            callBtn.disabled = true;
            setStatus("Calling...");
            try {
                const { resp, data } = await callApi("/api/call", { method: "POST" });
                setStatus(`HTTP ${resp.status}\n` + JSON.stringify(data, null, 2));
            } finally {
                callBtn.disabled = false;
            }
        });

        // On load, try to restore token
        loadTokenFromStorage();
    </script>
</body>

</html>
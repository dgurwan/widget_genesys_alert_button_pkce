<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Genesys Alert Button</title>

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            padding: 20px;
        }

        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 12px;
        }

        .btn {
            padding: 5px 5px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            color: white;
        }

        #callBtn {
            background: #d40000;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px 18px;
            font-size: 16px;
            cursor: pointer;
        }

        #callBtn:disabled,
        #loginBtn:disabled,
        #logoutBtn:disabled,
        #meBtn:disabled,
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #949393;
        }

        #status {
            margin-top: 15px;
            white-space: pre-wrap;
            background: #f6f6f6;
            padding: 10px;
            border-radius: 8px;
        }

        input {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            width: 260px;
        }

        .instructions {
            background: #eef3ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #loginBtn {
            background: #1f8101;
            padding: 10px 5px;
        }

        #logoutBtn {
            background: #c70202;
            padding: 10px 5px;
        }

        #meBtn {
            background: #0073e6;
            padding: 10px 5px;

        }


        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .status-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .status-logged-out {
            background-color: #d40000;
        }

        .status-processing {
            background-color: #ff9800;
        }

        .status-logged-in {
            background-color: #2e7d32;
        }
    </style>
</head>

<body>

    <div style="display: flex; right: 10px; position: absolute; top: 10px;">
        <button id="helpBtn">i</button>
    </div>
    <div class="instructions" id="instructions">
        <strong>How to test:</strong><br><br>
        1. The app automatically should redirect to login if not authenticated.<br>
        2. After login, your user info is automatically displayed.<br>
        3. Confirm the phone number is pre-filled.<br>
        4. Click <strong>SOS</strong> to create an outbound call.<br>
        5. Click <strong>Logout</strong> to reset the session.
    </div>

    <div class="status-indicator" id="status-indicator">
        <div id="statusDot" class="status-dot status-logged-out"></div>
        <div id="statusText">Logged out</div>
    </div>

    <div style="margin-top:12px">
        <input id="phoneInput" type="text" placeholder="+33123456789" />
    </div>

    <div style="margin-top:12px">
        <button id="callBtn">SOS</button>
    </div>

    <div class="row">
        <button class="btn" id="loginBtn">Login</button>
        <button class="btn" id="meBtn">Who am I?</button>
        <button class="btn" id="logoutBtn">Logout</button>
    </div>

    <div id="status"></div>




    <script>
        const loginBtn = document.getElementById("loginBtn");
        const meBtn = document.getElementById("meBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const callBtn = document.getElementById("callBtn");
        const status = document.getElementById("status");
        const phoneInput = document.getElementById("phoneInput");
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        const helpBtn = document.getElementById("helpBtn");
        const statusIndicator = document.getElementById("status-indicator");
        const instructions = document.getElementById("instructions");

        let accessToken = null;
        let debugMode = false;

        function debug() {
            if (!debugMode) {
                status.style.display = "none";
                instructions.style.display = "none";
                statusIndicator.style.display = "none";
                phoneInput.style.display = "none";
                loginBtn.style.display = "none";
                meBtn.style.display = "none";
                logoutBtn.style.display = "none";



            } else {
                status.style.display = "inline-block";
                instructions.style.display = "inline-block";
                statusIndicator.style.display = "inline-block";
                phoneInput.style.display = "inline-block";
                loginBtn.style.display = "inline-block";
                meBtn.style.display = "inline-block";
                logoutBtn.style.display = "inline-block";

            }
            debugMode = !debugMode;
        }

        function setStatus(msg) { status.textContent = msg; }

        function setIndicator(state) {
            statusDot.className = "status-dot";
            if (state === "logged-in") {
                statusDot.classList.add("status-logged-in");
                statusText.textContent = "Logged in";
            } else if (state === "processing") {
                statusDot.classList.add("status-processing");
                statusText.textContent = "Processing";
            } else {
                statusDot.classList.add("status-logged-out");
                statusText.textContent = "Logged out";
            }
        }

        function loadToken() {
            try {
                const raw = localStorage.getItem("gcAccessToken");
                if (!raw) return null;
                return JSON.parse(raw)?.access_token || null;
            } catch { return null; }
        }

        function clearToken() {
            localStorage.removeItem("gcAccessToken");
            accessToken = null;

            callBtn.disabled = true;  // disable call button when logged out
            loginBtn.disabled = false;   //  enable login again
            logoutBtn.disabled = true;   //  disable logout button when logged out
            setIndicator("logged-out");
        }

        async function callApi(url, opts = {}) {
            opts.headers = opts.headers || {};
            if (accessToken) opts.headers["Authorization"] = "Bearer " + accessToken;

            const resp = await fetch(url, opts);
            const text = await resp.text();
            let data;
            try { data = JSON.parse(text); } catch { data = { rawText: text }; }
            return { resp, data };
        }

        async function loadConfig() {
            try {
                const resp = await fetch("/config");
                if (!resp.ok) return;
                const cfg = await resp.json();
                if (cfg?.callNumber) phoneInput.value = cfg.callNumber;
            } catch { }
        }

        async function whoAmI() {
            if (!accessToken) {
                setIndicator("logged-out");
                callBtn.disabled = true;
                loginBtn.disabled = false;
                setStatus("Not authenticated.");
                return;
            }

            setIndicator("processing");

            const { resp, data } = await callApi("/api/me");
            setStatus(`HTTP ${resp.status}\n` + JSON.stringify(data, null, 2));

            if (resp.status === 401) {
                setIndicator("logged-out");
                clearToken();
                setStatus("Session expired. Redirecting to login...");
                login();

            } else if (resp.ok) {
                setIndicator("logged-in");
                callBtn.disabled = false; // enable call button when logged in
                loginBtn.disabled = true;   // disable login when logged in
            }
        }

        function login() {
            setIndicator("processing");
            window.location.href = "/auth/start";
        }

        async function logout() {
            await fetch("/auth/logout", { method: "POST" }).catch(() => { });
            clearToken();
            setStatus("Logged out.");
        }


        async function placeCall() {
            if (!accessToken) {
                setStatus("You are not authenticated. Please login first.");
                setIndicator("logged-out");
                return;
            }

            callBtn.disabled = true;
            setIndicator("processing");

            const phoneNumber = phoneInput.value.trim();
            if (!phoneNumber) {
                setStatus("Please enter a phone number.");
                callBtn.disabled = false;
                setIndicator("logged-in");
                return;
            }

            setStatus("Calling " + phoneNumber + "...");

            try {
                const { resp, data } = await callApi("/api/call", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ phoneNumber })
                });

                setStatus(`HTTP ${resp.status}\n` + JSON.stringify(data, null, 2));

                if (resp.status === 401) {
                    setIndicator("logged-out");
                    clearToken();
                } else if (resp.ok) {
                    setIndicator("logged-in");
                } else {
                    setIndicator("logged-in"); // still authenticated, but call failed
                }

            } catch (e) {
                setStatus("Call error: " + (e.message || e));
                setIndicator("logged-out");
            } finally {
                callBtn.disabled = false;
            }
        }

        /* Buttons */
        loginBtn.addEventListener("click", login);
        meBtn.addEventListener("click", whoAmI);
        logoutBtn.addEventListener("click", logout);
        callBtn.addEventListener("click", placeCall);
        helpBtn.addEventListener("click", debug);

        /* Auto login + auto WhoAmI */
        window.addEventListener("load", async () => {
            debug(); // start in debug mode with status visible
            callBtn.disabled = true;
            loginBtn.disabled = false;
            logoutBtn.disabled = true;


            setIndicator("processing");
            await loadConfig();

            accessToken = loadToken();

            if (!accessToken) {
                setIndicator("logged-out");
                setStatus("Not authenticated. Redirecting to login...");
                login(); // trigger login automatically
                return;
            }

            logoutBtn.disabled = false;

            await whoAmI();
        });
    </script>

</body>

</html>
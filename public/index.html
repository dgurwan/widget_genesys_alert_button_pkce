<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Genesys PKCE Call Button</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            padding: 40px;
        }

        #callBtn {
            background: #d40000;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 18px 26px;
            font-size: 18px;
            cursor: pointer;
        }

        #callBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            margin-right: 8px;
        }

        #status {
            margin-top: 18px;
            white-space: pre-wrap;
        }

        #top {
            margin-bottom: 18px;
        }
    </style>
</head>

<body>
    <div style="font-size: small;">
        <h1>Comment tester ?</h1>
        <p>
            Etape 1 : Se connecter à Genesys Cloud via le bouton "Login with Genesys Cloud (PKCE)".<br>
            Etape 2 (facultatif): Cliquer sur "Who am I?" pour vérifier que la connexion a réussi et pour voir les
            détails de votre
            compte.<br>
            Etape 3 (facultatif): Modifier le numéro si besoins<br>
            Etape 4 : Cliquer sur le bouton rouge "SOS" pour déclencher une action d'appel d'urgence vers le numéro et
            voir la réponse de l'API.
        </p>
    </div>

    <div id="top">
        <button class="btn" id="loginBtn">Connexion</button>
        <button class="btn" id="meBtn">Infos</button>
    </div>

    <button id="callBtn">SOS</button>
    <input type="text" id="phoneInput" placeholder="numéro SOS" />
    <div id="status"></div>

    <script>
        const loginBtn = document.getElementById("loginBtn");
        const meBtn = document.getElementById("meBtn");
        const callBtn = document.getElementById("callBtn");
        const status = document.getElementById("status");
        const phoneInput = document.getElementById("phoneInput");

        let accessToken = null;
        let defaultCallNumber = null;

        function setStatus(msg) { status.textContent = msg; }

        async function loadConfig() {
            const resp = await fetch("/config");
            if (!resp.ok) throw new Error("Failed to load /config");
            return resp.json();
        }

        async function init() {
            try {
                const cfg = await loadConfig();
                phoneInput.value = cfg.callNumber || "";
            } catch (e) {
                setStatus("Failed to load config: " + e.message);
            }
        }


        function loadTokenFromStorage() {
            try {
                const raw = window.localStorage.getItem("gcAccessToken");
                if (!raw) return;
                const obj = JSON.parse(raw);
                accessToken = obj.access_token || null;
                if (accessToken) setStatus("Token loaded from storage.");
            } catch (e) { }
        }

        async function callApi(url, opts = {}) {
            if (!opts.headers) opts.headers = {};
            if (accessToken) {
                opts.headers["Authorization"] = "Bearer " + accessToken;
            }

            const resp = await fetch(url, opts);
            const text = await resp.text();
            let data;
            try { data = JSON.parse(text); } catch { data = { rawText: text }; }
            return { resp, data };
        }

        loginBtn.addEventListener("click", () => {
            window.location.href = "/auth/start";
        });

        meBtn.addEventListener("click", async () => {
            const { resp, data } = await callApi("/api/me");
            setStatus(`HTTP ${resp.status}\n` + JSON.stringify(data, null, 2));
        });

        callBtn.addEventListener("click", async () => {
            callBtn.disabled = true;

            const phoneNumber = phoneInput.value.trim();

            if (!phoneNumber) {
                setStatus("Please enter a phone number.");
                callBtn.disabled = false;
                return;
            }

            setStatus("Calling " + phoneNumber + "...");

            try {
                const { resp, data } = await callApi("/api/call", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ phoneNumber })
                });

                setStatus(`HTTP ${resp.status}\n` + JSON.stringify(data, null, 2));
            } finally {
                callBtn.disabled = false;
            }
        });

        loadTokenFromStorage();
        init();
    </script>


</body>

</html>